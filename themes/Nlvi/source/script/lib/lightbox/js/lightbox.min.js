(function () {
  function toArray(nodeList) {
    return Array.prototype.slice.call(nodeList || []);
  }

  function createLightbox() {
    var overlay = document.createElement('div');
    overlay.id = 'lightboxOverlay';
    overlay.className = 'lightboxOverlay';
    overlay.style.display = 'none';

    var container = document.createElement('div');
    container.id = 'lightbox';
    container.className = 'lightbox';
    container.style.display = 'none';

    container.innerHTML =
      '<div class="lb-outerContainer">' +
      '  <div class="lb-container">' +
      '    <img class="lb-image" alt="" />' +
      '    <div class="lb-nav">' +
      '      <a class="lb-prev" href="#" aria-label="Previous image"></a>' +
      '      <a class="lb-next" href="#" aria-label="Next image"></a>' +
      '    </div>' +
      '    <div class="lb-loader"><a class="lb-cancel" href="#" aria-label="Close"></a></div>' +
      '  </div>' +
      '</div>' +
      '<div class="lb-dataContainer">' +
      '  <div class="lb-data">' +
      '    <div class="lb-details">' +
      '      <span class="lb-caption"></span>' +
      '      <span class="lb-number"></span>' +
      '    </div>' +
      '    <div class="lb-closeContainer"><a class="lb-close" href="#" aria-label="Close"></a></div>' +
      '  </div>' +
      '</div>';

    document.body.appendChild(overlay);
    document.body.appendChild(container);

    return {
      overlay: overlay,
      container: container,
      image: container.querySelector('.lb-image'),
      caption: container.querySelector('.lb-caption'),
      number: container.querySelector('.lb-number'),
      prev: container.querySelector('.lb-prev'),
      next: container.querySelector('.lb-next'),
      close: container.querySelector('.lb-close'),
      cancel: container.querySelector('.lb-cancel')
    };
  }

  function Lightbox() {
    this.items = [];
    this.index = 0;
    this.ui = null;
  }

  Lightbox.prototype.init = function () {
    this.ui = createLightbox();
    this.bindStaticHandlers();
    this.bindOpenHandlers();
  };

  Lightbox.prototype.bindStaticHandlers = function () {
    var self = this;

    this.ui.overlay.addEventListener('click', function () {
      self.close();
    });

    this.ui.close.addEventListener('click', function (e) {
      e.preventDefault();
      self.close();
    });

    this.ui.cancel.addEventListener('click', function (e) {
      e.preventDefault();
      self.close();
    });

    this.ui.prev.addEventListener('click', function (e) {
      e.preventDefault();
      self.show(self.index - 1);
    });

    this.ui.next.addEventListener('click', function (e) {
      e.preventDefault();
      self.show(self.index + 1);
    });

    document.addEventListener('keydown', function (e) {
      if (self.ui.container.style.display !== 'block') return;
      if (e.key === 'Escape') self.close();
      if (e.key === 'ArrowLeft') self.show(self.index - 1);
      if (e.key === 'ArrowRight') self.show(self.index + 1);
    });
  };

  Lightbox.prototype.bindOpenHandlers = function () {
    var self = this;

    document.body.addEventListener('click', function (e) {
      var target = e.target;
      if (!target) return;

      var anchor = target.closest('a[rel^="lightbox"], area[rel^="lightbox"], a[data-lightbox], area[data-lightbox]');
      if (!anchor) return;

      e.preventDefault();
      self.collect(anchor);
      self.open();
    });
  };

  Lightbox.prototype.collect = function (anchor) {
    var group = anchor.getAttribute('data-lightbox') || anchor.getAttribute('rel');
    var selector;

    if (group) {
      if (anchor.hasAttribute('data-lightbox')) {
        selector = anchor.tagName + '[data-lightbox="' + group + '"]';
      } else {
        selector = anchor.tagName + '[rel="' + group + '"]';
      }
      this.items = toArray(document.querySelectorAll(selector));
    } else {
      this.items = [anchor];
    }

    this.index = Math.max(0, this.items.indexOf(anchor));
  };

  Lightbox.prototype.open = function () {
    this.ui.overlay.style.display = 'block';
    this.ui.container.style.display = 'block';
    document.documentElement.classList.add('lb-disable-scrolling');
    this.show(this.index);
  };

  Lightbox.prototype.close = function () {
    this.ui.overlay.style.display = 'none';
    this.ui.container.style.display = 'none';
    document.documentElement.classList.remove('lb-disable-scrolling');
  };

  Lightbox.prototype.show = function (index) {
    if (!this.items.length) return;

    if (index < 0) index = this.items.length - 1;
    if (index >= this.items.length) index = 0;
    this.index = index;

    var anchor = this.items[index];
    var link = anchor.getAttribute('href');
    var title = anchor.getAttribute('data-title') || anchor.getAttribute('title') || '';
    var alt = anchor.getAttribute('data-alt') || '';

    this.ui.image.setAttribute('src', link);
    this.ui.image.setAttribute('alt', alt);
    this.ui.caption.textContent = title;
    this.ui.number.textContent = this.items.length > 1 ? 'Image ' + (index + 1) + ' of ' + this.items.length : '';

    this.ui.prev.style.display = this.items.length > 1 ? 'block' : 'none';
    this.ui.next.style.display = this.items.length > 1 ? 'block' : 'none';
  };

  document.addEventListener('DOMContentLoaded', function () {
    var lb = new Lightbox();
    lb.init();
    window.lightbox = lb;
  });
})();
